name: 'ci-cd'
on:
  push:
    branches:
      - main
    # 也可以设置 tag 触发 ci
    # tags:
      # - 'v*'
  pull_request:
    branches:
      - main
jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup node version
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Install
        run: yarn install
      - name: Run unit tests
        run: yarn test --ci
      - name: Configure git info
        run: |
          git config --global user.email "$GITHUB_ACTOR@gmail.com"
          git config --global user.name "$GITHUB_ACTOR"
      - name: Build
        run: yarn run build
      # --conventional-commits: 表示自动根据 git 提交历史的 type 来决定升级哪部分版本号，参考 https://github.com/lerna/lerna/blob/main/commands/version/README.md#--conventional-commits
      # --yes: 表示默认以 yes 跳过所有交互式问答，在 CI/CD 自动化中使用
      - name: Publish to npm
        run: |
          npm whoami
          npx lerna publish --conventional-commits --yes

